---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const featuredPosts = posts.filter(post => post.data.featured);
const allPosts = posts;

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

const tags = [...new Set(posts.flatMap(post => post.data.tags))];
---

<Layout 
  title="Blog"
  description="Thoughts on ML engineering, systems design, and the intersection of research and production."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 relative">
    <div class="absolute inset-0 grid-pattern opacity-20 pointer-events-none"></div>
    <div class="absolute top-0 right-0 w-1/2 h-96 bg-gradient-radial from-pulse/10 to-transparent pointer-events-none"></div>
    
    <div class="relative max-w-7xl mx-auto px-8 sm:px-12 lg:px-20 xl:px-28 2xl:px-32">
      <div class="max-w-3xl mb-16">
        <span class="font-mono text-sm text-pulse tracking-wider uppercase mb-4 block">Blog</span>
        <h1 class="text-5xl md:text-6xl font-display mb-6">
          Thoughts on<br/>
          <span class="gradient-text">building things</span>
        </h1>
        <p class="text-xl text-ink-muted leading-relaxed">
          Writing about ML engineering, systems design, research, and the craft of 
          building software that matters. For engineers, scientists, and curious minds.
        </p>
      </div>
      
      <!-- Tags -->
      <div class="flex flex-wrap gap-3">
        <span class="tag-filter-btn active">All</span>
        {tags.slice(0, 6).map(tag => (
          <a 
            href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
            class="tag-filter-btn"
          >
            {tag}
          </a>
        ))}
      </div>
    </div>
  </section>
  
  <!-- Featured Posts -->
  {featuredPosts.length > 0 && (
    <section class="pb-16">
      <div class="max-w-7xl mx-auto px-8 sm:px-12 lg:px-20 xl:px-28 2xl:px-32">
        <h2 class="text-2xl font-display mb-8 flex items-center gap-3">
          <span class="w-2 h-2 rounded-full bg-spark"></span>
          Featured
        </h2>
        
        <div class="grid md:grid-cols-2 gap-8">
          {featuredPosts.map((post, i) => (
            <a 
              href={`/blog/${post.slug}`}
              class="group blog-card card-interactive overflow-hidden animate-on-scroll"
              style={`animation-delay: ${i * 150}ms`}
              data-blog-card
            >
              <!-- Featured Image (if exists) -->
              {post.data.heroImage && (
                <div 
                  class="relative aspect-[16/9] overflow-hidden rounded-t-2xl"
                  transition:name={`blog-image-${post.slug}`}
                >
                  <img 
                    src={post.data.heroImage} 
                    alt={post.data.title}
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent"></div>
                </div>
              )}
              
              <!-- Gradient border effect (only if no image) -->
              {!post.data.heroImage && (
                <div class="h-1 bg-gradient-to-r from-spark via-signal to-pulse"></div>
              )}
              
              <div class="p-8">
                <!-- Meta -->
                <div class="flex items-center gap-4 text-sm mb-4" style="color: var(--ink-tertiary);">
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDate(post.data.pubDate)}
                  </time>
                  <span class="w-1 h-1 rounded-full" style="background-color: var(--border-default);"></span>
                  <span>{post.data.readTime || '5 min read'}</span>
                </div>
                
                <!-- Title -->
                <h3 
                  class="text-2xl font-display mb-4 leading-snug transition-colors"
                  style="color: var(--ink-primary);"
                  transition:name={`blog-title-${post.slug}`}
                >
                  {post.data.title}
                </h3>
                
                <!-- Description -->
                <p class="mb-6 line-clamp-3" style="color: var(--ink-secondary);">
                  {post.data.description}
                </p>
                
                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mb-6">
                  {post.data.tags.slice(0, 3).map(tag => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
                
                <!-- Read more -->
                <div class="flex items-center text-sm font-medium transition-colors" style="color: var(--accent-primary);">
                  Read article
                  <svg class="w-4 h-4 ml-2 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
  
  <!-- All Posts -->
  <section class="py-16 section-divider">
    <div class="max-w-7xl mx-auto px-8 sm:px-12 lg:px-20 xl:px-28 2xl:px-32">
      <h2 class="text-2xl font-display mb-8">All Posts</h2>
      
      <div class="space-y-6">
        {allPosts.map((post, i) => (
          <a 
            href={`/blog/${post.slug}`}
            class="group blog-card card-interactive p-6 flex flex-col md:flex-row md:items-center gap-6 animate-on-scroll"
            style={`animation-delay: ${i * 100}ms`}
            data-blog-card
          >
            <!-- Thumbnail -->
            {post.data.heroImage && (
              <div 
                class="md:w-40 flex-shrink-0 aspect-[16/9] rounded-2xl overflow-hidden"
                transition:name={`blog-image-${post.slug}`}
              >
                <img 
                  src={post.data.heroImage} 
                  alt={post.data.title}
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                />
              </div>
            )}
            
            <!-- Date (if no image) -->
            {!post.data.heroImage && (
              <div class="md:w-32 flex-shrink-0">
                <time 
                  datetime={post.data.pubDate.toISOString()}
                  class="text-sm font-mono"
                  style="color: var(--ink-tertiary);"
                >
                  {formatDate(post.data.pubDate)}
                </time>
              </div>
            )}
            
            <!-- Content -->
            <div class="flex-1">
              {post.data.heroImage && (
                <time 
                  datetime={post.data.pubDate.toISOString()}
                  class="text-sm font-mono mb-2 block"
                  style="color: var(--ink-tertiary);"
                >
                  {formatDate(post.data.pubDate)}
                </time>
              )}
              <h3 
                class="text-xl font-display mb-2 transition-colors group-hover:text-evergreen-500 dark:group-hover:text-evergreen-400"
                style="color: var(--ink-primary);"
                transition:name={`blog-title-${post.slug}`}
              >
                {post.data.title}
              </h3>
              <p class="text-sm line-clamp-2 mb-3" style="color: var(--ink-secondary);">
                {post.data.description}
              </p>
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            </div>
            
            <!-- Read time & Arrow -->
            <div class="md:w-32 flex-shrink-0 flex items-center justify-end gap-4">
              <span class="text-sm" style="color: var(--ink-tertiary);">{post.data.readTime || '5 min'}</span>
              <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-all" style="color: var(--ink-tertiary);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
  
  <!-- Newsletter -->
  <section class="py-24 section-divider">
    <div class="max-w-4xl mx-auto px-8 sm:px-12 lg:px-20 xl:px-28 2xl:px-32">
      <div class="card p-8 md:p-12 bg-gradient-to-br from-void-100 to-void-200 text-center">
        <h2 class="text-3xl font-display text-ink mb-4">
          Subscribe to the newsletter
        </h2>
        <p class="text-ink-muted mb-8 max-w-lg mx-auto">
          Get notified when I publish new articles on ML engineering, systems design, 
          and the intersection of research and production.
        </p>
        <form class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
          <input 
            type="email" 
            placeholder="your@email.com"
            class="flex-1 px-5 py-3 rounded-full bg-void-50 border border-void-400 text-ink placeholder:text-ink-faint focus:outline-none focus:border-spark transition-colors"
          />
          <button type="submit" class="btn-primary whitespace-nowrap">
            Subscribe
          </button>
        </form>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Section divider - subtle in dark mode */
  .section-divider {
    border-top: 1px solid var(--border-subtle);
  }
  
  :global(.dark) .section-divider {
    border-top-color: rgba(42, 61, 53, 0.4);
  }
  
  /* Tag filter buttons */
  .tag-filter-btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    background-color: var(--surface-tertiary);
    color: var(--ink-secondary);
    border: 1px solid var(--border-subtle);
  }
  
  .tag-filter-btn:hover {
    background-color: var(--surface-elevated);
    color: var(--ink-primary);
    border-color: var(--border-default);
    transform: translateY(-1px);
  }
  
  .tag-filter-btn.active {
    background-color: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }
  
  /* Blog card hover effects */
  .blog-card {
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), 
                box-shadow 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  .blog-card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 20px 40px var(--shadow-color, rgba(0, 0, 0, 0.15));
  }
  
  /* Featured cards have stronger effect */
  section:nth-of-type(2) .blog-card:hover {
    transform: translateY(-6px) scale(1.015);
    box-shadow: 0 24px 48px var(--shadow-color, rgba(0, 0, 0, 0.2));
  }
  
  /* Image zoom on hover */
  .blog-card img {
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  .blog-card:hover img {
    transform: scale(1.08);
  }
  
  /* Title color change on hover */
  .blog-card:hover h3 {
    color: var(--accent-primary) !important;
  }
</style>

