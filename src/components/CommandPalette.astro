---
// Command Palette - Cmd+K search interface
// const currentPath = Astro.url.pathname; // Removed - currently unused
---

<div id="command-palette" class="command-palette hidden" role="dialog" aria-label="Command Palette">
  <!-- Backdrop -->
  <div class="command-palette-backdrop"></div>

  <!-- Modal -->
  <div class="command-palette-modal" role="document">
    <!-- Search Input -->
    <div class="command-palette-header">
      <svg class="search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        id="command-palette-input"
        class="command-palette-input"
        placeholder="Search or jump to..."
        autocomplete="off"
        spellcheck="false"
        aria-label="Search"
      />
      <kbd class="command-palette-kbd">ESC</kbd>
    </div>

    <!-- Results -->
    <div class="command-palette-results" id="command-palette-results">
      <!-- Results will be injected here -->
    </div>

    <!-- Footer -->
    <div class="command-palette-footer">
      <div class="command-palette-footer-item">
        <kbd>â†‘â†“</kbd> Navigate
      </div>
      <div class="command-palette-footer-item">
        <kbd>â†µ</kbd> Select
      </div>
      <div class="command-palette-footer-item">
        <kbd>ESC</kbd> Close
      </div>
    </div>
  </div>
</div>

<style>
  .command-palette {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .command-palette.hidden {
    pointer-events: none;
  }

  .command-palette.hidden .command-palette-backdrop {
    opacity: 0;
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
  }

  .command-palette.hidden .command-palette-modal {
    opacity: 0;
    transform: scale(0.92) translateY(-20px);
  }

  .command-palette-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    opacity: 1;
    transition:
      opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1),
      backdrop-filter 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  :global(.dark) .command-palette-backdrop {
    background: rgba(0, 0, 0, 0.7);
  }

  .command-palette-modal {
    position: relative;
    width: 100%;
    max-width: 640px;
    margin: 0 1rem;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.95) 0%,
      rgba(255, 255, 255, 0.9) 100%
    );
    backdrop-filter: blur(24px) saturate(180%);
    border-radius: 1.5rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow:
      0 20px 40px -12px rgba(0, 0, 0, 0.25),
      inset 0 1px 1px rgba(255, 255, 255, 0.6);
    overflow: hidden;
    opacity: 1;
    transform: scale(1) translateY(0);
    transition:
      transform 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.1s,
      opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1) 0.1s;
  }

  :global(.dark) .command-palette-modal {
    background: linear-gradient(
      135deg,
      rgba(20, 20, 20, 0.95) 0%,
      rgba(15, 15, 15, 0.9) 100%
    );
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow:
      0 20px 40px -12px rgba(0, 0, 0, 0.6),
      inset 0 1px 1px rgba(255, 255, 255, 0.08);
  }

  .command-palette-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  :global(.dark) .command-palette-header {
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  .search-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--ink-tertiary);
    flex-shrink: 0;
  }

  .command-palette-input {
    flex: 1;
    font-size: 1rem;
    color: var(--ink-primary);
    background: transparent;
    border: none;
    outline: none;
  }

  .command-palette-input:focus {
    outline: none;
    border: none;
    box-shadow: none;
  }

  .command-palette-input::placeholder {
    color: var(--ink-tertiary);
  }

  .command-palette-kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--ink-tertiary);
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
    min-width: 2rem;
  }

  :global(.dark) .command-palette-kbd {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .command-palette-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .command-palette-results::-webkit-scrollbar {
    width: 8px;
  }

  .command-palette-results::-webkit-scrollbar-track {
    background: transparent;
  }

  .command-palette-results::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 4px;
  }

  :global(.dark) .command-palette-results::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
  }

  .command-palette-footer {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    font-size: 0.75rem;
    color: var(--ink-tertiary);
  }

  :global(.dark) .command-palette-footer {
    border-top-color: rgba(255, 255, 255, 0.1);
  }

  .command-palette-footer-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .command-palette-footer kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.125rem 0.375rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.675rem;
    font-weight: 500;
    color: var(--ink-tertiary);
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.25rem;
    min-width: 1.5rem;
  }

  :global(.dark) .command-palette-footer kbd {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
  }

  /* Result Groups */
  :global(.command-palette-group) {
    margin-bottom: 0.75rem;
  }

  :global(.command-palette-group:last-child) {
    margin-bottom: 0;
  }

  :global(.command-palette-group-title) {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--ink-tertiary);
  }

  :global(.command-palette-item) {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.16, 1, 0.3, 1);
    text-decoration: none;
  }

  :global(.command-palette-item:hover),
  :global(.command-palette-item.selected) {
    background: rgba(18, 87, 74, 0.1);
  }

  :global(.dark .command-palette-item:hover),
  :global(.dark .command-palette-item.selected) {
    background: rgba(74, 222, 128, 0.15);
  }

  :global(.command-palette-item-icon) {
    font-size: 1.25rem;
    line-height: 1;
    flex-shrink: 0;
  }

  :global(.command-palette-item-content) {
    flex: 1;
    min-width: 0;
  }

  :global(.command-palette-item-title) {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--ink-primary);
    margin-bottom: 0.125rem;
  }

  :global(.command-palette-item-description) {
    font-size: 0.75rem;
    color: var(--ink-tertiary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.command-palette-empty) {
    padding: 3rem 1.5rem;
    text-align: center;
    color: var(--ink-tertiary);
  }
</style>

<script>
  import Fuse from 'fuse.js';
  import { buildSearchIndex, type SearchItem } from '../utils/searchIndex';

  let isOpen = false;
  let selectedIndex = 0;
  let currentResults: SearchItem[] = [];
  let fuse: Fuse<SearchItem>;

  function openCommandPalette() {
    const palette = document.getElementById('command-palette');
    const input = document.getElementById('command-palette-input') as HTMLInputElement;

    if (!palette || !input) return;

    isOpen = true;
    palette.classList.remove('hidden');
    input.value = '';
    input.focus();

    // Initialize search index and Fuse.js
    const currentPath = window.location.pathname;
    const searchIndex = buildSearchIndex(currentPath);
    currentResults = searchIndex;

    fuse = new Fuse(searchIndex, {
      keys: ['title', 'description', 'keywords'],
      threshold: 0.3,
      includeScore: true
    });

    renderResults(currentResults);
  }

  function closeCommandPalette() {
    const palette = document.getElementById('command-palette');
    if (!palette) return;

    isOpen = false;
    palette.classList.add('hidden');
    selectedIndex = 0;
    currentResults = [];
  }

  function renderResults(results: SearchItem[]) {
    const resultsContainer = document.getElementById('command-palette-results');
    if (!resultsContainer) return;

    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="command-palette-empty">No results found</div>';
      return;
    }

    // Group results by type
    const groups: Record<string, SearchItem[]> = {
      section: [],
      page: [],
      action: [],
      post: [],
      project: []
    };

    results.forEach(item => {
      if (groups[item.type]) {
        groups[item.type].push(item);
      }
    });

    let html = '';

    // Current page sections first
    if (groups.section.length > 0) {
      html += '<div class="command-palette-group">';
      html += '<div class="command-palette-group-title">Sections on this page</div>';
      groups.section.forEach((item, index) => {
        html += renderItem(item, index);
      });
      html += '</div>';
    }

    // Quick actions
    if (groups.action.length > 0) {
      html += '<div class="command-palette-group">';
      html += '<div class="command-palette-group-title">Quick actions</div>';
      groups.action.forEach((item, index) => {
        const globalIndex = groups.section.length + index;
        html += renderItem(item, globalIndex);
      });
      html += '</div>';
    }

    // Pages
    if (groups.page.length > 0) {
      html += '<div class="command-palette-group">';
      html += '<div class="command-palette-group-title">Pages</div>';
      groups.page.forEach((item, index) => {
        const globalIndex = groups.section.length + groups.action.length + index;
        html += renderItem(item, globalIndex);
      });
      html += '</div>';
    }

    resultsContainer.innerHTML = html;

    // Add click handlers
    const items = resultsContainer.querySelectorAll('.command-palette-item');
    items.forEach((item, index) => {
      item.addEventListener('click', () => {
        selectedIndex = index;
        selectItem();
      });
    });
  }

  function renderItem(item: SearchItem, index: number): string {
    const isSelected = index === selectedIndex;
    return `
      <div class="command-palette-item ${isSelected ? 'selected' : ''}" data-index="${index}" data-href="${item.href}">
        <div class="command-palette-item-icon">${item.icon || 'ðŸ“„'}</div>
        <div class="command-palette-item-content">
          <div class="command-palette-item-title">${item.title}</div>
          ${item.description ? `<div class="command-palette-item-description">${item.description}</div>` : ''}
        </div>
      </div>
    `;
  }

  function selectItem() {
    const items = document.querySelectorAll('.command-palette-item');
    if (items.length === 0 || selectedIndex >= items.length) return;

    const selectedItem = items[selectedIndex] as HTMLElement;
    const href = selectedItem.dataset.href;

    if (href) {
      closeCommandPalette();
      window.location.href = href;
    }
  }

  function handleSearch(query: string) {
    if (!query.trim()) {
      // Show default results
      const currentPath = window.location.pathname;
      currentResults = buildSearchIndex(currentPath);
      renderResults(currentResults);
      return;
    }

    // Perform fuzzy search
    const results = fuse.search(query);
    currentResults = results.map(result => result.item);
    selectedIndex = 0;
    renderResults(currentResults);
  }

  function handleKeyDown(e: KeyboardEvent) {
    if (!isOpen) return;

    switch (e.key) {
      case 'Escape':
        e.preventDefault();
        closeCommandPalette();
        break;

      case 'ArrowDown':
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
        renderResults(currentResults);
        // Scroll selected item into view after render
        requestAnimationFrame(() => {
          const items = document.querySelectorAll('.command-palette-item');
          const selectedItem = items[selectedIndex] as HTMLElement;
          if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        });
        break;

      case 'ArrowUp':
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        renderResults(currentResults);
        // Scroll selected item into view after render
        requestAnimationFrame(() => {
          const items = document.querySelectorAll('.command-palette-item');
          const selectedItem = items[selectedIndex] as HTMLElement;
          if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        });
        break;

      case 'Enter':
        e.preventDefault();
        selectItem();
        break;
    }
  }

  // Listen for custom event to open palette
  document.addEventListener('openCommandPalette', openCommandPalette);

  // Listen for backdrop click
  document.addEventListener('click', (e) => {
    const backdrop = (e.target as HTMLElement).closest('.command-palette-backdrop');
    if (backdrop && isOpen) {
      closeCommandPalette();
    }
  });

  // Listen for input changes
  const input = document.getElementById('command-palette-input');
  if (input) {
    let debounceTimer: number;
    input.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(() => {
        const query = (e.target as HTMLInputElement).value;
        handleSearch(query);
      }, 150);
    });
  }

  // Listen for keyboard shortcuts globally
  document.addEventListener('keydown', handleKeyDown);

  // Re-initialize on page transitions
  document.addEventListener('astro:page-load', () => {
    selectedIndex = 0;
    if (isOpen) {
      closeCommandPalette();
    }
  });
</script>
