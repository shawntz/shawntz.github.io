---
// Spotify Playlist Component
// Configure your Spotify playlist IDs here
const playlists = [
  { id: "37i9dQZF1DXcBWIGoYBM5M", name: "Today's Top Hits" },
  { id: "37i9dQZF1DX0XUsuxWHRQd", name: "RapCaviar" },
  { id: "37i9dQZF1DWXRqgorJj26U", name: "Rock Classics" },
  { id: "37i9dQZF1DX4sWSpwq3LiO", name: "Peaceful Piano" },
  { id: "37i9dQZF1DX1lVhptIYRda", name: "Hot Country" },
];
---

<section id="music" class="py-16 lg:py-24 page-section overflow-hidden" style="opacity: 0;">
  <div class="max-w-[1800px] mx-auto px-8 sm:px-12 lg:px-20 xl:px-28 2xl:px-32">
    <!-- Section Header -->
    <div class="grid lg:grid-cols-2 gap-8 lg:gap-24 mb-12">
      <div>
        <span class="text-xs font-mono uppercase tracking-widest mb-6 block" style="color: var(--ink-tertiary);">
          Now Playing
        </span>
        <h2 class="text-4xl md:text-5xl lg:text-6xl font-display font-medium leading-[1.1]" style="color: var(--ink-primary);">
          What I've been listening to
        </h2>
      </div>
      <div class="lg:pt-12">
        <p class="text-lg leading-relaxed" style="color: var(--ink-secondary);">
          Music fuels my focus. Here are some of my curated playlists that keep me in the zoneâ€”
          from deep work sessions to late-night coding marathons.
        </p>
      </div>
    </div>
    
    <!-- Playlist Selector with Cover Flow -->
    <div class="spotify-player-container">
      <!-- Cover Flow for Playlist Selection -->
      <div class="coverflow-container relative mb-8">
        <!-- Navigation Arrows -->
        <button 
          id="coverflow-prev" 
          class="nav-button nav-button-prev"
          aria-label="Previous playlist"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <button 
          id="coverflow-next" 
          class="nav-button nav-button-next"
          aria-label="Next playlist"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
        
        <!-- Cover Flow Stage -->
        <div class="coverflow-stage" style="perspective: 1000px;">
          <div id="coverflow-track" class="coverflow-track">
            {playlists.map((playlist, index) => (
              <div 
                class={`coverflow-item ${index === 0 ? 'active' : ''}`}
                data-playlist-id={playlist.id}
                data-playlist-name={playlist.name}
                data-index={index}
              >
                <div class="coverflow-album">
                  <img 
                    src=""
                    alt={playlist.name}
                    class="album-art"
                    data-playlist-id={playlist.id}
                    loading="lazy"
                  />
                  <div class="album-shine"></div>
                </div>
                <div class="playlist-label">
                  <span class="playlist-name-label">{playlist.name}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
        
        <!-- Pagination Dots -->
        <div id="coverflow-dots" class="flex justify-center gap-2 mt-6">
          {playlists.map((_, index) => (
            <button 
              class={`coverflow-dot ${index === 0 ? 'active' : ''}`}
              data-index={index}
              aria-label={`Go to playlist ${index + 1}`}
            />
          ))}
        </div>
      </div>
      
      <!-- Spotify Embed Player -->
      <div class="embed-container">
        <div id="spotify-embed-wrapper" class="spotify-embed-wrapper">
          <iframe 
            id="spotify-embed"
            style="border-radius: 12px;"
            src={`https://open.spotify.com/embed/playlist/${playlists[0].id}?utm_source=generator&theme=0`}
            width="100%" 
            height="450" 
            frameBorder="0" 
            allowfullscreen="" 
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
            loading="lazy"
          ></iframe>
        </div>
        
        <!-- Open in Spotify Link -->
        <div class="text-center mt-6">
          <a 
            id="spotify-open-link"
            href={`https://open.spotify.com/playlist/${playlists[0].id}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-full text-sm font-medium transition-all duration-300 spotify-button"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
            </svg>
            Open Full Playlist in Spotify
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .spotify-player-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  /* Cover Flow */
  .coverflow-container {
    position: relative;
    padding: 0 50px;
  }
  
  @media (min-width: 768px) {
    .coverflow-container {
      padding: 0 60px;
    }
  }
  
  .coverflow-stage {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 260px;
    position: relative;
    overflow: hidden;
  }
  
  @media (min-width: 640px) {
    .coverflow-stage {
      height: 300px;
      overflow: visible;
    }
  }
  
  @media (min-width: 768px) {
    .coverflow-stage {
      height: 340px;
    }
  }
  
  .coverflow-track {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transform-style: preserve-3d;
    width: 100%;
    height: 100%;
  }
  
  .coverflow-item {
    position: absolute;
    width: 180px;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    transform-style: preserve-3d;
    cursor: pointer;
    opacity: 0.9;
  }
  
  @media (min-width: 640px) {
    .coverflow-item {
      width: 200px;
    }
  }
  
  @media (min-width: 768px) {
    .coverflow-item {
      width: 220px;
    }
  }
  
  @media (min-width: 1024px) {
    .coverflow-item {
      width: 240px;
    }
  }
  
  .coverflow-item.active {
    opacity: 1;
    z-index: 10;
  }
  
  .coverflow-item.adjacent {
    opacity: 0.95;
  }
  
  .coverflow-album {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
  }

  .coverflow-item.active .coverflow-album {
    box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.5);
  }

  /* Hide the shadow on mobile */
  @media (max-width: 639px) {
    .coverflow-album,
    .coverflow-item.active .coverflow-album {
      box-shadow: none;
    }
    
    .nav-button {
      box-shadow: none;
    }
  }
  
  .coverflow-item.active:hover .coverflow-album {
    transform: scale(1.03);
  }
  
  .album-art {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: linear-gradient(135deg, var(--surface-tertiary) 0%, var(--surface-secondary) 100%);
  }
  
  .album-shine {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%, transparent 100%);
    pointer-events: none;
  }
  
  .playlist-label {
    text-align: center;
    margin-top: 16px;
    opacity: 0;
    transform: translateY(5px);
    transition: all 0.3s ease;
  }
  
  .coverflow-item.active .playlist-label {
    opacity: 1;
    transform: translateY(0);
  }
  
  .playlist-name-label {
    font-family: var(--font-display, 'Fraunces', serif);
    font-weight: 500;
    font-size: 1.125rem;
    color: var(--ink-primary);
  }
  
  /* Navigation Buttons */
  .nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background-color: var(--surface-elevated);
    border: 1px solid var(--border-subtle);
    box-shadow: 0 4px 15px var(--shadow-color);
    color: var(--ink-primary);
  }
  
  .nav-button:hover {
    border-color: #1DB954;
    color: #1DB954;
    transform: translateY(-50%) scale(1.1);
  }
  
  .nav-button-prev {
    left: 0;
  }
  
  .nav-button-next {
    right: 0;
  }
  
  @media (max-width: 640px) {
    .coverflow-container {
      padding: 0 40px;
    }
    
    .nav-button {
      width: 40px;
      height: 40px;
    }
  }
  
  /* Pagination Dots */
  .coverflow-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--border-default);
    border: none;
    padding: 0;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .coverflow-dot:hover {
    background-color: var(--ink-tertiary);
  }
  
  .coverflow-dot.active {
    background-color: #1DB954;
    transform: scale(1.4);
  }
  
  /* Spotify Embed */
  .embed-container {
    background: var(--surface-secondary);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid var(--border-subtle);
  }
  
  .spotify-embed-wrapper {
    border-radius: 12px;
    overflow: hidden;
  }
  
  .spotify-embed-wrapper iframe {
    display: block;
  }
  
  .spotify-button {
    background-color: #1DB954;
    color: white;
  }
  
  .spotify-button:hover {
    background-color: #1ed760;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
  }
  
  /* Dark mode adjustments for embed container */
  :global(.dark) .embed-container {
    background: var(--surface-tertiary);
  }
</style>

<script>
  function initSpotifyPlayer() {
    const items = document.querySelectorAll('.coverflow-item');
    const prevBtn = document.getElementById('coverflow-prev');
    const nextBtn = document.getElementById('coverflow-next');
    const dots = document.querySelectorAll('.coverflow-dot');
    const embed = document.getElementById('spotify-embed') as HTMLIFrameElement;
    const openLink = document.getElementById('spotify-open-link');
    
    if (!items.length) return;
    
    let currentIndex = 0;
    const totalItems = items.length;
    
    // Fetch playlist artwork
    async function fetchPlaylistArt(playlistId: string): Promise<string> {
      try {
        const response = await fetch(`https://open.spotify.com/oembed?url=https://open.spotify.com/playlist/${playlistId}`);
        const data = await response.json();
        return data.thumbnail_url || '';
      } catch {
        return '';
      }
    }
    
    // Load all playlist artwork
    async function loadArtwork() {
      const images = document.querySelectorAll('.album-art[data-playlist-id]');
      
      for (const img of images) {
        const playlistId = img.getAttribute('data-playlist-id');
        if (playlistId) {
          const artUrl = await fetchPlaylistArt(playlistId);
          if (artUrl) {
            (img as HTMLImageElement).src = artUrl;
          }
        }
      }
    }
    
    // Position items in cover flow - Apple iPod style with even spacing
    function positionItems() {
      const itemEl = items[0]?.querySelector('.coverflow-album') as HTMLElement;
      const itemWidth = itemEl?.offsetWidth || 200;
      
      // Classic iPod Cover Flow parameters
      const sideRotation = 65; // Rotation angle for side items (degrees)
      const sideSpacing = itemWidth * 0.22; // Consistent spacing between side items
      const centerOffset = itemWidth * 0.55; // Distance from center to first side item
      
      items.forEach((item, index) => {
        const offset = index - currentIndex;
        const element = item as HTMLElement;
        
        element.classList.remove('active', 'adjacent');
        
        let translateX: number;
        let translateZ: number;
        let rotateY: number;
        
        if (offset === 0) {
          // Center item - no rotation, pushed forward
          translateX = 0;
          translateZ = 120;
          rotateY = 0;
          element.classList.add('active');
        } else {
          // Side items - consistent spacing and rotation
          const direction = offset > 0 ? 1 : -1;
          const absOffset = Math.abs(offset);
          
          // First side item starts at centerOffset, subsequent items spaced evenly
          translateX = direction * (centerOffset + (absOffset - 1) * sideSpacing);
          translateZ = 0;
          rotateY = -direction * sideRotation;
          
          if (absOffset === 1) {
            element.classList.add('adjacent');
          }
        }
        
        element.style.transform = `translateX(${translateX}px) translateZ(${translateZ}px) rotateY(${rotateY}deg)`;
        element.style.zIndex = String(50 - Math.abs(offset));
      });
      
      // Update dots
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentIndex);
      });
    }
    
    // Update Spotify embed
    function updateEmbed() {
      const activeItem = items[currentIndex];
      const playlistId = activeItem?.getAttribute('data-playlist-id');
      
      if (embed && playlistId) {
        embed.src = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator&theme=0`;
      }
      
      if (openLink && playlistId) {
        openLink.setAttribute('href', `https://open.spotify.com/playlist/${playlistId}`);
      }
    }
    
    // Navigate to index
    function goTo(index: number) {
      currentIndex = ((index % totalItems) + totalItems) % totalItems;
      positionItems();
      updateEmbed();
    }
    
    // Event listeners
    prevBtn?.addEventListener('click', () => goTo(currentIndex - 1));
    nextBtn?.addEventListener('click', () => goTo(currentIndex + 1));
    
    // Dot navigation
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.getAttribute('data-index') || '0');
        goTo(index);
      });
    });
    
    // Click on item to select
    items.forEach((item) => {
      item.addEventListener('click', () => {
        const index = parseInt(item.getAttribute('data-index') || '0');
        if (index !== currentIndex) {
          goTo(index);
        }
      });
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const section = document.getElementById('music');
      if (!section) return;
      
      const rect = section.getBoundingClientRect();
      const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
      
      if (isVisible) {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          goTo(currentIndex - 1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          goTo(currentIndex + 1);
        }
      }
    });
    
    // Touch support
    let touchStartX = 0;
    const stage = document.querySelector('.coverflow-stage');
    
    stage?.addEventListener('touchstart', (e: TouchEvent) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    stage?.addEventListener('touchend', (e: TouchEvent) => {
      const touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > 50) {
        goTo(diff > 0 ? currentIndex + 1 : currentIndex - 1);
      }
    }, { passive: true });
    
    // Initialize
    loadArtwork();
    positionItems();
  }
  
  // Run initialization
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSpotifyPlayer);
    } else {
      initSpotifyPlayer();
    }
    
    document.addEventListener('astro:page-load', initSpotifyPlayer);
  }
</script>
